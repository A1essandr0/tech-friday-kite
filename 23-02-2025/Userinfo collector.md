Было:

![[uc_old.png]](uc_old.png)

(вебсервер и роутер нам предоставлен FastAPI, контейнеры приложения и управление зависимостями - dependency_injector-ом)

Проблемы:
- Вся бизнес-логика живет прямо в контроллере
- Куда добавлять новую логику, которая потребовалась?
- Логика становится все сложнее - как ее тестировать?
- Желательно переиспользовать ресурсы http/tcp соединений - как выяснилось, внутри aiohttp с определенного их количества начинаются утечки памяти

***

Стало:

![[uc_evo.png]](uc_evo.png)

- В контроллере остается логика препроцессинга и постпроцессинга данных, не связанная с бизнес-задачей. Валидация, подготовка ответа, отправка в Кафку. 
- Собственно процессинг вынесен в юзкейс, названный Processor. В него инжектятся репозитории и дополнительные модули процессинга, каждый из которых отвечает за отдельную партнерку и логику присущую специфически ей. 
- Нет проблем добавить другие партнерки, другие модули обработки данных и даже другие юзкейсы.
- Т.к. и репозиторий, и эти модули активно ходят наружу по http, то http-клиент выделен как зависимость и внедрен в них. На его уровне управляем пулом соединений через aiohttp.ClientSession